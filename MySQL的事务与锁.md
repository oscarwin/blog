# MySQL的事务与锁

提到事务首先想到的当然是事务的四个特性：原子性、一致性、隔离性、持久性

## 事务的四个特性

**原子性：**事务的所有操作在数据库中要么全部正确的反映出来，要么完全不反映。

**一致性：**事务执行前后数据库的数据保持一致。

**隔离性：**多个事务并发执行时，对于任何一对事务Ti和Tj，在Ti看来，Tj 要么在 Ti 之前已经完成执行，或者在Ti完成之后开始执行。因此，每个事务都感觉不到系统中有其他事务在并发执行。

**持久性：**一个事务成功完成后，它对数据库的改变必须是永久的，即使事务刚提交机器就宕机了数据也不能丢。

事务的原子性和持久性比较好理解，但是一致性会更加抽象一些。对于一致性经常有个转账的例子，A 给 B 转账，转账前后 A 和 B 的账户总和不变就是一致的。这个例子咋一看好像很清楚，但转念一想原子性是不是也能达到这个目的呢？答案是：不能，原子性可以保证 A 账户扣减和 B 账户增加同时成功或者同时失败，但是并不能保证 A 扣减的数量等于 B 增加的数量。实际上是为了达到一致性所以要同时满足其他三个条件。

还有一个事务的隔离性比较复杂，因为 MySQL 的事务可以有多种隔离级别，接下里一起看看。

## 事务的隔离级别

当多个事务并发执行时可能存在脏读(dirty read)，不可重复读(non-repeatable read)和幻读(phantom read)，为了解决这些问题因此引入了不同的隔离级别。

**脏读：**事务 A 和事务 B 并发执行时，事务 B 可以读到事务 A 未提交的数据，就发生了脏读。脏读的本质在于事务 B 读了事务 A 未提交的数据，如果事务 A 发生了回滚，那么事务 B 读到的数据实际上是无效的。
| 事务A | 事务B |
| :--- | :--- |
| begin | begin |
| update t set count = 100 |  |
|       | select count from t |
| rollback |  |
| commit | commit |

**不可重复读：**

## 参考

[1] 数据库系统概念(第6版)
[2] MySQL实战45讲，林晓斌
[3] 高性能MySQL